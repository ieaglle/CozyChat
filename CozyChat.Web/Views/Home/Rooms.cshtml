@{
    ViewBag.Title = "Rooms";
}

<h2>Rooms</h2>


<div class="row">
    
    <div class="col-md-2">
        
        <div class="btn-group-vertical" data-bind="foreach: chatRooms">
            <button type="button" class="btn btn-default btn-sm" data-bind="text: Name, click: $root.selectRoom"></button>
        </div>
    </div>
    <div class="col-md-8">Messages</div>
    <div class="col-md-2">
        <ul data-bind="foreach: currentRoomUsers">
            <li><span data-bind="text: Name"></span></li>
        </ul>
    </div>
</div>

<script type="text/javascript">

     $(document).ready(function() {

         var proxy = $.connection.cozyChatHub;
         $.connection.hub.start();

         proxy.client.notify = function(val) {
             alert(val);
         };
         

         function RoomsViewModel() {
             var self = this;

             self.chatRooms = ko.observableArray();
             self.currentRoomUsers = ko.observableArray();
             self.currentRoomMessages = ko.observableArray();

             self.selectedRoom = ko.observable();

             self.activate = function() {
                 $.ajax({
                     type: 'GET',
                     url: '@Url.Action("GetSubscribedRooms")',
                     success: function(content) {
                         vm.chatRooms(content);
                         console.log(content);
                     }
                 });
             }

             self.selectRoom = function(selectedRoom) {
                 $.ajax({
                     type: 'GET',
                     url: '@Url.Action("GetUsersSubscribedToRoom")',
                     data: { roomId: selectedRoom.Id },
                     success: function (content) {
                         proxy.server.join('trololo');

                         vm.currentRoomUsers(content);


                         self.selectedRoom(content);

                         console.log(content);
                     }
                 });
             };
         }

         var vm = new RoomsViewModel();
         ko.applyBindings(vm);
         vm.activate();

     });
 </script>

